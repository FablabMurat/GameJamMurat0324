[gd_scene load_steps=31 format=3 uid="uid://nabnyuuxgolm"]

[ext_resource type="Texture2D" uid="uid://d4nodvq41hpb2" path="res://Ressources/Joueur/garcon-derriere0001.png" id="1_dfh5f"]
[ext_resource type="Texture2D" uid="uid://dam3kaiqeie48" path="res://Ressources/Joueur/garcon-derriere0002.png" id="2_l6r4v"]
[ext_resource type="Texture2D" uid="uid://b8ggfp7kuo6jb" path="res://Ressources/Joueur/garcon-derriere0003.png" id="3_dqb3o"]
[ext_resource type="Texture2D" uid="uid://b3oa43kf2tmko" path="res://Ressources/Joueur/garcon-derriere0004.png" id="4_s36os"]
[ext_resource type="Texture2D" uid="uid://mtfiqs8hnta8" path="res://Ressources/Joueur/garcon-derriere0005.png" id="5_ur1pn"]
[ext_resource type="Texture2D" uid="uid://uhr847oy7wjm" path="res://Ressources/Joueur/garcon-derriere0006.png" id="6_p8ue8"]
[ext_resource type="Texture2D" uid="uid://bvs1is5ruab5k" path="res://Ressources/Joueur/garcon-derriere0007.png" id="7_5aow7"]
[ext_resource type="Texture2D" uid="uid://daldkrcsmoqas" path="res://Ressources/Joueur/garcon-derriere0008.png" id="8_k0hrm"]
[ext_resource type="Texture2D" uid="uid://d2t0y5rai6r07" path="res://Ressources/Joueur/garcon-devant0001.png" id="9_qsd3a"]
[ext_resource type="Texture2D" uid="uid://d3atnqqxxo2iy" path="res://Ressources/Joueur/garcon-devant0002.png" id="10_hxdbx"]
[ext_resource type="Texture2D" uid="uid://dgvrrto0holeh" path="res://Ressources/Joueur/garcon-devant0003.png" id="11_neyl7"]
[ext_resource type="Texture2D" uid="uid://cv5x3tk0m1ok3" path="res://Ressources/Joueur/garcon-devant0004.png" id="12_w4qri"]
[ext_resource type="Texture2D" uid="uid://cs0563fxn7cx7" path="res://Ressources/Joueur/garcon-devant0005.png" id="13_2pxb3"]
[ext_resource type="Texture2D" uid="uid://b3fp1d27iptmp" path="res://Ressources/Joueur/garcon-devant0006.png" id="14_hr7bq"]
[ext_resource type="Texture2D" uid="uid://bmyqk6fvuxc1y" path="res://Ressources/Joueur/garcon-devant0007.png" id="15_ju0fr"]
[ext_resource type="Texture2D" uid="uid://b3824k28sc6um" path="res://Ressources/Joueur/garcon-devant0008.png" id="16_rj1xf"]
[ext_resource type="Texture2D" uid="uid://ddx6hbs0u0tpq" path="res://Ressources/Joueur/garcon-droite0001.png" id="17_7vgos"]
[ext_resource type="Texture2D" uid="uid://be84uxatp0vng" path="res://Ressources/Joueur/garcon-droite0002.png" id="18_1236m"]
[ext_resource type="Texture2D" uid="uid://ckajnafol0ln1" path="res://Ressources/Joueur/garcon-droite0003.png" id="19_dc031"]
[ext_resource type="Texture2D" uid="uid://cc10pspwvmuoo" path="res://Ressources/Joueur/garcon-droite0004.png" id="20_vf006"]
[ext_resource type="Texture2D" uid="uid://bjryusyfdwlnd" path="res://Ressources/Joueur/garcon-droite0005.png" id="21_urhfe"]
[ext_resource type="Texture2D" uid="uid://duqiu5tcuseat" path="res://Ressources/Joueur/garcon-droite0006.png" id="22_c47i5"]
[ext_resource type="Texture2D" uid="uid://dfssh3uaphxio" path="res://Ressources/Joueur/garcon-droite0007.png" id="23_bdbna"]
[ext_resource type="Texture2D" uid="uid://5ymk7x4tpm81" path="res://Ressources/Joueur/garcon-droite0008.png" id="24_xfn8y"]
[ext_resource type="PackedScene" uid="uid://bo236qdt0iu0w" path="res://neige_particules.tscn" id="25_r15d7"]
[ext_resource type="AudioStream" uid="uid://cmtdvujgrglhb" path="res://Ressources/Sons/pas_2.ogg" id="26_8nggx"]

[sub_resource type="GDScript" id="GDScript_wemyt"]
script/source = "extends CharacterBody3D

@export var PLAYER_SPEED = 500
var camrot = 0.0

var direction = Vector3.ZERO
const COS45 = sqrt(2)/2
const NBMAX = {
	\"buche\": 3,
	\"hache\": 1
}
var nbbuche = 0

const PTS_MAX_HACHE = 20

var nbhache = 0
var listPtsHaches = []

var sapinsProches = {}
var flagPresDuFeu = false

signal collected
signal increaseFire
signal stepSpawn
signal score
signal message

func _ready():
	$PlayerCenter/Camera3D.set_current(true)

func _physics_process(delta):
	direction.x = Input.get_action_strength(\"move_right\") - Input.get_action_strength(\"move_left\")
	direction.z = Input.get_action_strength(\"move_forward\") - Input.get_action_strength(\"move_backwards\")
	
	velocity = direction.normalized().rotated(Vector3.UP,$PlayerCenter.rotation.y) * PLAYER_SPEED
	set_velocity(velocity * delta)
	move_and_slide()
	
	var dejaunehache = false
	for index in get_slide_collision_count():
		var collision = get_slide_collision(index)
		var body = collision.get_collider()
		if body.is_in_group(\"buche\")  and  nbbuche < NBMAX[\"buche\"]:
			#print(\"player collect buche\")
			nbbuche += 1
			body.queue_free()
			# mettre à jour l'UI
			collected.emit(\"buche\",1)
		
		elif body.is_in_group(\"hache\") and not dejaunehache :
			# Attention, on peut avoir 2 collisions : une par Body3D...
			#print(\"player collect hache\")
			nbhache += 1
			dejaunehache = true
			body.queue_free()
			listPtsHaches.append(PTS_MAX_HACHE)
			collected.emit(\"hache\",1)
		
		elif body.is_in_group(\"feu\") and nbbuche > 0 :
			#print(\"mettre une buche dans le feu\")
			increaseFire.emit(nbbuche)
			nbbuche = 0
		else:
			# contact avec un élément du décor avec mask=2 (sinon on passe à travers)
			pass #prints(\"autre collision avec (arbre, sol ou rocher ?) \",body)
		

func _process(delta):
	#var tmprot = Input.get_action_strength(\"look_right\") - Input.get_action_strength(\"look_left\")
	#if abs(tmprot) > 0.1:
	#	camrot += tmprot * 0.05
	#	$PlayerCenter.set_rotation(Vector3(0, camrot, 0))
	#	print(\"Camera3D Rotation: \", camrot)
	$PlayerCenter.set_rotation(Vector3(0, camrot, 0))
	
	animate()

func _unhandled_input(event):
	if event is InputEventMouseMotion:
		if event.button_mask & (MOUSE_BUTTON_MASK_MIDDLE + MOUSE_BUTTON_MASK_RIGHT):
			camrot += event.relative.x * 0.005
			#print(\"Camera3D Rotation: \", camrot)

func animate():
	if(velocity != Vector3.ZERO):
		$PlayerCenter/PlayerSprite3D.play()
		var realdirection = velocity.rotated(Vector3.UP,-$PlayerCenter.rotation.y)
		if(realdirection.x > COS45):
			$PlayerCenter/PlayerSprite3D.animation = \"side\"
			$PlayerCenter/PlayerSprite3D.flip_h = false
		elif(realdirection.x < -COS45):
			$PlayerCenter/PlayerSprite3D.animation = \"side\"
			$PlayerCenter/PlayerSprite3D.flip_h = true
		elif(realdirection.z <= -COS45):
			$PlayerCenter/PlayerSprite3D.animation = \"front\"
		elif(realdirection.z >= COS45):
			$PlayerCenter/PlayerSprite3D.animation = \"back\"
		else:
			pass
			# On est inanimé car bloqué
			#print(\"animate impossible %d/%d\" % [realdirection.x,realdirection.z])
	else:
		$PlayerCenter/PlayerSprite3D.stop()

func has_hache():
	return nbhache > 0

func _on_step_timer_timeout():
	if(velocity != Vector3.ZERO):
		stepSpawn.emit()
		$StepStreamPlayer.play()


func _on_area_3d_body_entered(body):
	if body.is_in_group(\"arbre\"):
		#print (\"près d'un arbre \")
		sapinsProches[body.get_rid()] = body
	elif body.is_in_group(\"feu\"):
		# on est suffisamment proche du feu
		flagPresDuFeu = true
		$PresDuFeuTimer.start()
		#print (\"près du feu \")
		#$FoyerStreamPlayer.start()
	else:
		pass
		#prints (\"autre body :\", body)
		
func _on_area_3d_body_exited(body):
	if body.is_in_group(\"arbre\"):
		#print(\"loin d'un' sapin\")
		sapinsProches.erase(body.get_rid())
	elif body.is_in_group(\"feu\"):
		$PresDuFeuTimer.stop()
		#$FoyerStreamPlayer.stop()

func _on_pres_du_feu_timer_timeout():
	if velocity.x == 0  and  velocity.z == 0:
		score.emit(10)

func _input(event):
	if event.is_action_pressed(\"ui_hache\"):
		if not sapinsProches.is_empty():
			sapinsProches.values()[0].cutwood()
			if has_hache():
				# coupe d'un arbre
				useHache()
			else:
				var imgpng = ResourceLoader.load(\"res://Ressources/Environnement/Hache.png\")
				message.emit(\"il faut d'abord une hache !\",imgpng)
		else:
			var imgpng = ResourceLoader.load(\"res://Ressources/Environnement/Arbre_4.png\")
			message.emit(\"pas de sapin ici !\",imgpng)

func useHache():
	if listPtsHaches.size() > 0:
		# Utilise la hache et
		listPtsHaches[0] -= 1
		if listPtsHaches[0] == 0 :
			listPtsHaches.remove_at(0)
			nbhache -= 1
			collected.emit(\"hache\",-1)
			# TODO : averti de la  perte de la hache
			pass
			# En rebalancer une ailleurs
			get_parent().recreatehache()

func _on_foyer_stream_player_finished():
	$FoyerStreamPlayer.start()
	pass # Replace with function body.

"

[sub_resource type="SpriteFrames" id="SpriteFrames_hlw7m"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": ExtResource("1_dfh5f")
}, {
"duration": 1.0,
"texture": ExtResource("2_l6r4v")
}, {
"duration": 1.0,
"texture": ExtResource("3_dqb3o")
}, {
"duration": 1.0,
"texture": ExtResource("4_s36os")
}, {
"duration": 1.0,
"texture": ExtResource("5_ur1pn")
}, {
"duration": 1.0,
"texture": ExtResource("6_p8ue8")
}, {
"duration": 1.0,
"texture": ExtResource("7_5aow7")
}, {
"duration": 1.0,
"texture": ExtResource("8_k0hrm")
}],
"loop": true,
"name": &"back",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("9_qsd3a")
}, {
"duration": 1.0,
"texture": ExtResource("10_hxdbx")
}, {
"duration": 1.0,
"texture": ExtResource("11_neyl7")
}, {
"duration": 1.0,
"texture": ExtResource("12_w4qri")
}, {
"duration": 1.0,
"texture": ExtResource("13_2pxb3")
}, {
"duration": 1.0,
"texture": ExtResource("14_hr7bq")
}, {
"duration": 1.0,
"texture": ExtResource("15_ju0fr")
}, {
"duration": 1.0,
"texture": ExtResource("16_rj1xf")
}],
"loop": true,
"name": &"front",
"speed": 10.0
}, {
"frames": [{
"duration": 1.0,
"texture": ExtResource("17_7vgos")
}, {
"duration": 1.0,
"texture": ExtResource("18_1236m")
}, {
"duration": 1.0,
"texture": ExtResource("19_dc031")
}, {
"duration": 1.0,
"texture": ExtResource("20_vf006")
}, {
"duration": 1.0,
"texture": ExtResource("21_urhfe")
}, {
"duration": 1.0,
"texture": ExtResource("22_c47i5")
}, {
"duration": 1.0,
"texture": ExtResource("23_bdbna")
}, {
"duration": 1.0,
"texture": ExtResource("24_xfn8y")
}],
"loop": true,
"name": &"side",
"speed": 10.0
}]

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_rycr6"]

[sub_resource type="CylinderShape3D" id="CylinderShape3D_bni8i"]
radius = 1.43018

[node name="Player" type="CharacterBody3D" groups=["player"]]
collision_layer = 3
collision_mask = 6
script = SubResource("GDScript_wemyt")

[node name="PlayerCenter" type="Marker3D" parent="."]
transform = Transform3D(2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0.1, 0)

[node name="PlayerSprite3D" type="AnimatedSprite3D" parent="PlayerCenter"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.0613341, 0)
offset = Vector2(0, 40)
billboard = 1
sprite_frames = SubResource("SpriteFrames_hlw7m")
animation = &"back"

[node name="Camera3D" type="Camera3D" parent="PlayerCenter"]
transform = Transform3D(0.499997, -0.000421824, 0.00164857, -0.000923824, 0.33951, 0.367059, 0.00142908, 0.36706, -0.339507, 0, 4.4165, -4.23686)
current = true

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.96303, 0)
shape = SubResource("CapsuleShape3D_rycr6")

[node name="StepTimer" type="Timer" parent="."]
wait_time = 0.5
autostart = true

[node name="Neige" parent="." instance=ExtResource("25_r15d7")]

[node name="StepStreamPlayer" type="AudioStreamPlayer" parent="."]
stream = ExtResource("26_8nggx")

[node name="Area3D" type="Area3D" parent="."]
collision_layer = 0
collision_mask = 4

[node name="CollisionShape3D" type="CollisionShape3D" parent="Area3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0)
shape = SubResource("CylinderShape3D_bni8i")

[node name="FoyerStreamPlayer" type="AudioStreamPlayer" parent="."]

[node name="PresDuFeuTimer" type="Timer" parent="."]

[connection signal="timeout" from="StepTimer" to="." method="_on_step_timer_timeout"]
[connection signal="body_entered" from="Area3D" to="." method="_on_area_3d_body_entered"]
[connection signal="body_exited" from="Area3D" to="." method="_on_area_3d_body_exited"]
[connection signal="finished" from="FoyerStreamPlayer" to="." method="_on_foyer_stream_player_finished"]
[connection signal="timeout" from="PresDuFeuTimer" to="." method="_on_pres_du_feu_timer_timeout"]
